name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.2.3) â€” empty = auto-bump minor from last tag'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Compute version
        run: |
          INPUT="${{ inputs.version }}"
          INPUT="${INPUT#v}"

          if [ -n "$INPUT" ]; then
            VERSION="$INPUT"
          else
            LATEST=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
            if [ -z "$LATEST" ]; then
              VERSION="0.1.0"
            else
              LATEST="${LATEST#v}"
              IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST"
              VERSION="$MAJOR.$((MINOR + 1)).0"
            fi
          fi

          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Tag and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREV=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          if [ -n "$PREV" ]; then
            NOTES=$(git log --oneline "$PREV..HEAD")
          else
            NOTES=$(git log --oneline)
          fi

          gh release create "v$VERSION" --title "v$VERSION" --notes "$NOTES"

      - name: Log in to ghcr.io
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build and push frontend
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          push: true
          tags: |
            ghcr.io/automaat/finance-buddy-frontend:latest
            ghcr.io/automaat/finance-buddy-frontend:v${{ env.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push backend
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ./backend
          push: true
          tags: |
            ghcr.io/automaat/finance-buddy-backend:latest
            ghcr.io/automaat/finance-buddy-backend:v${{ env.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
